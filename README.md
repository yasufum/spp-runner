# SPP Runner

## Table of Contents

- [What is this](#what-is-this)

## What is this

A management tool for SPP.


### SPP

[SPP](http://www.dpdk.org/browse/apps/spp/)
is a kind of Inter-VM communication technology
which is implemented using Intel DPDK.
You can configure network path between applications on host and guest VMs
with SPP.

SPP provides not only high-performance connectivity, but also flexibility
with patch panel like interface.


## Usage

### Run SPP and VMs

You start from running `bin/wakeup.py` which is a script for preparing
environment on your terminal.
This script opens several windows with [tmux](https://tmux.github.io/)
for SPP primary process,
secondary processes and VMs.
Therefore, you need to install `tmux`
before run the script.

`bin/wakeup.py` takes arguments and passes them to runscripts.
For instance, you can run two secondaries, one ring VM and one vhost VM as following.

```sh
$ ./bin/wakeup.py -ns 2 -nr 1 -nv 1

# It is defined as default value. It's also the same.
$ ./bin/wakeup.py
```

This command opens six windows with `tmux`.

  1. SPP controller
  1. SPP primary
  1. SPP secondaries
  1. ring VM
  1. vhost VM
  1. working dir

The last one is for a working directory to manage VMs.

Refer help and `How to use` section for details..

  ```sh
  $ ./wakeup.py -h
  usage: wakeup.py [-h] [-t] [-ns NOF_SEC] [-nr NOF_RING] [-nv NOF_VHOST]
                   [-vn VHOST_NUM] [-nw NOF_WORKING]

  Run SPP and VMs

  optional arguments:
    -h, --help            show this help message and exit
    -t, --template        Boot template VM
    -ns NOF_SEC, --nof-sec NOF_SEC
                          Number of SPP secondaries
    -nr NOF_RING, --nof-ring NOF_RING
                          Number of VMs running ring
    -nv NOF_VHOST, --nof-vhost NOF_VHOST
                          Number of VMs running vhost
    -vn VHOST_NUM, --vhost-num VHOST_NUM
                          Number of vhost interfaces
    -nw NOF_WORKING, --nof-working NOF_WORKING
                          Number of working window
  ```


## How to use

### Directory structure

This tool is assumed to use with other two tools,
`qemu-setup` and `spp-vm-installer`(optional).
Without `spp-vm-installer`, you have to install
SPP by your own.

You have to put all tools in a directory before run it.

```sh
# check tools are placed in the same dir
$ ls -aF
qemu-setup/  spp-runner/  spp-vm-installer/ ...
```

### Prepare VM image

First, you need to prepare an image as base template,
"base" means that there are other two templates for
ring and vhost VMs.
Two of them are generated by using base tempalte.

Put base template image in `runscripts` directory.

  ```sh
  $ cp /path/to/template runscripts/
  ```

I have tested only `ubuntu16.04-server-amd64`, so
it's recommended.

[NOTE] Default type of image is `qcow2`, but you can use
other types by editing `run-vm.py` in `qemu-setup/runscripts`.


### Configuration

Configuration is described in `conf.yml`.
Basically, you don't need to edit without change core assignment.

  ```
  ---
  
  controller:
    host: "127.0.0.1"
    pri_port: 5555
    sec_port: 6666
  
  primary:
    coremask: 0x03  # 2 cores
  
  secondaries:
    - id: 1
      coremask: "0x0C"  # 2 cores
    - id: 2
      coremask: "0x30"  # 2 cores
    - id: 3
      coremask: "0xC0"  # 2 cores
    - id: 4
      coremask: "0x300"  # 2 cores
    - id: 5
      coremask: "0xC00"  # 2 cores
    #- id: 6
    #- coremask: "0x3000"  # 2 cores
  
  vms_ring:
    - id: 6
    - id: 7
    - id: 8
    - id: 9
    - id: 10
  
  vms_vhost:
    - id: 11
    - id: 12
    - id: 13
    - id: 14
    - id: 15
  ```

It's divided into five parts each of which responds to
entity as following.

#### SPP controller

  - host: IP address of controller node
  - pri_port: Port SPP primary process connects to (should not change)
  - sec_port: Port SPP secondary processes connect to (should not change)

#### SPP primary 

  - coremask: CPU cores SPP primary uses

You must avoid to overlap with secondary processes.
So, confirm not to overlap with them if you change it.

You can monitor statistics if you assign two or more.
It requires at least one core and monitoring is disabled
in this case.


#### SPP secondary

  - id: secondary ID
  - coremask: CPU cores SPP secondary uses

id attr responds to secondary ID and it's given to
`runscripts/secondary.sh` to use it as a option for
running secondary process.

#### VM(ring)

  - id: VM ID respond to secondary ID running on the VM

#### VM(vhost)

  - id: VM ID respond to secondary ID running on the VM


### Generate templates for ring and vhost VMs

VMs are booted from `wakeup.py`.
But you have to confirm that you have already prepared 
tempaltes before running VMs.

#### Understand how to manage images

There are two steps for running VMs.
First, you generate templates for ring and vhost from
base template.
Generated ring template is named by adding prefix "or" to
base template.
It's similar for vhost template but prefix is "ov".
Then, generate images for each of VMs as instances from
ring or vhost template. This instance images are put into
`qemu-setup/runscripts/img/`.

As you run `wakeup.py`, it tries to boot VMs using image in
`qemu-setup/runscripts/img/`.
If there is no image in the `img` directory, then `wakeup.py`
tries to generate instance from ring or vhost template.
In the same manner, ring and vhost templates are generated
from base template if they don't exist.

Therefore, you have to put only base template image at first time.

##### 4-2. Setup ring and vhost templates

Before running `wakeup.py`, you must put base template
into `qemu-setup/runscripts/` and make sure that
other templates don't exist.

Run `wakeup.py`.

  ```sh
  $ ./bin/wakeup.py
  ```

Six tmux's windows appear in your terminal and last window is focused.
In primary, secondaries and VMs window, command is prompted for input
password
(SPP controller doesn't require sudo).

As described in SPP's documents, you have to run processes in order.

  1. SPP controller
  2. primary
  3. seconrdaries and ring VM
  4. vhost VM (after create socket)


